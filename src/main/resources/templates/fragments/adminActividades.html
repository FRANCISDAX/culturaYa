<div th:fragment="adminActividades">
    <!-- Encabezado de página -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Actividades</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/admin/dashboard}">Inicio</a></li>
                    <li class="breadcrumb-item active">Actividades</li>
                </ol>
            </nav>
        </div>
        <div>
            <!-- Botón para abrir el modal nativo -->
            <button type="button" class="btn btn-primary" onclick="document.getElementById('nuevaActividadModal').showModal()">
                <i class="bi bi-plus-circle me-2"></i>
                Nueva Actividad
            </button>

        </div>
    </div>
    
    <main class="container">
                <!-- Mensajes Flash para éxito y error -->
        <div th:if="${exito}" 
            class="alert alert-success alert-dismissible fade show auto-hide-alert" 
            role="alert" 
            data-auto-hide="3000">
            <i class="bi bi-check-circle-fill me-2"></i>
            <span th:text="${exito}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${error}" 
            class="alert alert-danger alert-dismissible fade show auto-hide-alert" 
            role="alert" 
            data-auto-hide="3000">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <!-- Mensaje si no hay actividades -->
        <div th:if="${#lists.isEmpty(actividades)}" class="alert alert-info text-center" role="alert">
            No hay actividades registradas.
        </div>
        <!-- Filtro de Categorías -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center gap-2">
                <label for="filtroCategoria" class="form-label mb-0 fw-semibold">
                    Filtrar por categoría:
                </label>
                <select id="filtroCategoria" class="form-select form-select-sm" style="width: 220px;">
                    <option value="TODAS">Todas las categorías</option>
                    <option th:each="cat : ${T(com.culturaweb.culturaya.model.enums.Categoria).values()}"
                            th:value="${cat}"
                            th:text="${cat}">
                    </option>
                </select>
            </div>
        </div>
        <!-- Listado de actividades -->
        <div th:unless="${#lists.isEmpty(actividades)}" class="row g-4">
            <div th:each="actividad : ${actividades}" class="col-12" th:attr="data-categoria=${actividad.categoria}">
                <div class="card shadow-sm h-100">
                    <div class="row g-0">
                        <!-- Imagen -->
                        <div class="col-md-3">
                            <img th:src="${actividad.imagen}" 
                                 class="img-fluid rounded-start h-100 object-fit-cover" 
                                 alt="Imagen de la actividad"
                                 style="object-fit: cover; height: 128px;">
                        </div>

                        <!-- Contenido -->
                        <div class="col-md-9">
                            <div class="card-body d-flex flex-column h-100">
                                <h5 class="card-title" th:text="${actividad.titulo}">Título</h5>
                                <p class="card-text text-muted" 
                                   th:text="${#strings.abbreviate(actividad.descripcion, 200)}">Contenido...</p>
                                <a th:href="${actividad.enlace}" target="_blank" 
                                   class="btn btn-outline-primary btn-sm mt-auto align-self-start">
                                    Ver más →
                                </a>

                                <!-- Fecha -->
                                <small class="text-muted mt-2">
                                    Publicado: 
                                    <span th:text="${#temporals.format(actividad.fechaPublicacion, 'dd/MM/yyyy HH:mm')}">01/01/2024</span>
                                    <span th:if="${actividad.fechaActualizacion != null}">
                                        | Actualizado: 
                                        <span th:text="${#temporals.format(actividad.fechaActualizacion, 'dd/MM/yyyy HH:mm')}">01/01/2024</span>
                                    </span>
                                </small>

                                <!-- Botones de acción -->
                                <div class="mt-2">
                                    <button type="button" 
                                        class="btn btn-warning btn-sm me-2" 
                                        style="width: 120px;"
                                        th:data-id="${actividad.id}"
                                        th:data-titulo="${actividad.titulo}"
                                        th:data-categoria="${actividad.categoria}"
                                        th:data-lugar="${actividad.lugar}"
                                        th:data-fecha="${actividad.fecha}"
                                        th:data-precio="${actividad.precio}"
                                        th:data-descripcion="${actividad.descripcion}"
                                        th:data-enlace="${actividad.enlace}"
                                        th:data-imagen="${actividad.imagen}"
                                        onclick="abrirModalEditarActividad(this)">
                                        Editar
                                    </button>
                                    <a th:href="@{/admin/actividades/eliminar(id=${actividad.id})}" 
                                        class="btn btn-danger btn-sm"
                                        style="width: 120px;"
                                        onclick="return confirm('¿Eliminar esta actividad?')">
                                        Eliminar
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal nativo HTML para Nueva Noticia -->
    <dialog id="nuevaActividadModal" class="modal-dialog-native">

        <div class="modal-content-native">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-event"></i> Registrar Nueva Actividad
                </h5>
                <!-- Botón para cerrar el modal nativo -->
                <form method="dialog">
                    <button type="submit" class="btn-close btn-close-white" aria-label="Close"></button>
                </form>
            </div>
            <div class="modal-body">
                <form th:action="@{/admin/actividades/guardar}" method="post" th:object="${actividad}" enctype="multipart/form-data" id="actividadForm">
                    
                    <!-- Título -->
                    <div class="mb-3">
                        <label for="titulo" class="form-label">Título *</label>
                        <input type="text" 
                            class="form-control" 
                            id="titulo" 
                            th:field="*{titulo}" 
                            maxlength="100"
                            required>
                        <div class="text-danger" th:if="${#fields.hasErrors('titulo')}" th:errors="*{titulo}"></div>
                    </div>

                    <!-- Categoría -->
                    <div class="mb-3">
                        <label for="categoria" class="form-label">Categoría *</label>
                        <select th:field="*{categoria}" required>
                            <option value="">-- Selecciona una categoría --</option>
                            <option th:each="cat : ${T(com.culturaweb.culturaya.model.enums.Categoria).values()}"
                                    th:value="${cat}"
                                    th:text="${cat}">
                            </option>                                
                        </select>
                        <div class="text-danger" th:if="${#fields.hasErrors('categoria')}" th:errors="*{categoria}"></div>
                    </div>

                    <!-- Lugar -->
                    <div class="mb-3">
                        <label for="lugar" class="form-label">Lugar *</label>
                        <input type="text" 
                                class="form-control" 
                                id="lugar" 
                                th:field="*{lugar}" 
                                maxlength="100">
                        <div class="text-danger" th:if="${#fields.hasErrors('lugar')}" th:errors="*{lugar}"></div>
                    </div>

                    <div class="row">
                        <!-- Fecha -->
                        <div class="col-md-6 mb-3">
                            <label for="fecha" class="form-label">Fecha *</label>
                            <input type="text" 
                                    class="form-control" 
                                    id="fecha" 
                                    th:field="*{fecha}"
                                    maxlength="100" 
                                    required>
                            <div class="text-danger" th:if="${#fields.hasErrors('fecha')}" th:errors="*{fecha}"></div>
                        </div>
                        <!-- Precio -->
                        <div class="col-md-6 mb-3">
                            <label for="precio" class="form-label">Precio *</label>
                            <input type="text" 
                                    class="form-control" 
                                    id="precio" 
                                    th:field="*{precio}"
                                    maxlength="100" 
                                    required>
                            <div class="text-danger" th:if="${#fields.hasErrors('precio')}" th:errors="*{precio}"></div>
                        </div>
                    </div>

                    <!-- Descripción -->
                    <div class="mb-3">
                        <label for="descripcion" class="form-label">Descripción *</label>
                        <textarea class="form-control" 
                                    id="descripcion" 
                                    th:field="*{descripcion}" 
                                    rows="3" 
                                    maxlength="500"></textarea>
                        <div class="text-danger" th:if="${#fields.hasErrors('descripcion')}" th:errors="*{descripcion}"></div>
                    </div>

                    <!-- Nombre de la imagen -->
                    <div class="mb-3">
                        <label for="imagenFile" class="form-label">Imagen *</label>
                        <input type="file" 
                            class="form-control" 
                            id="imagenFile" 
                            maxlength="200"
                            accept="image/*" 
                            name="imagenFile"
                            required>
                        <div class="text-danger" th:if="${#fields.hasErrors('imagen')}" th:errors="*{imagen}"></div>
                    </div>

                    <!-- URL del enlace -->
                    <div class="mb-3">
                        <label for="enlace" class="form-label">URL del Enlace *</label>
                        <input type="url" 
                            class="form-control" 
                            id="enlace" 
                            th:field="*{enlace}" 
                            maxlength="200" 
                            placeholder="https://actividad.com/detalle"
                            required>
                        <div class="text-danger" th:if="${#fields.hasErrors('enlace')}" th:errors="*{enlace}"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <!-- Form para cerrar el modal con el método dialog -->
                <form method="dialog">
                    <button type="submit" class="btn btn-secondary">Cancelar</button>
                </form>
                <button type="submit" form="actividadForm" class="btn btn-primary">Guardar Actividad</button>
            </div>
        </div>

    </dialog>

    <!-- Modal para Editar Actividad -->
    <dialog id="editarActividadModal" class="modal-dialog-native">

        <div class="modal-content-native">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-event"></i> Editar Actividad
                </h5>
                <!-- Botón para cerrar el modal nativo -->
                <form method="dialog">
                    <button type="submit" class="btn-close btn-close-white" aria-label="Close"></button>
                </form>
            </div>
            <div class="modal-body">
                <form th:action="@{/admin/actividades/guardar}" method="post" th:object="${actividad}" enctype="multipart/form-data" id="editarActividadForm">
                    <input type="hidden" id="editarId" th:field="*{id}">

                    <!-- Título -->
                    <div class="mb-3">
                        <label for="titulo" class="form-label">Título *</label>
                        <input type="text" 
                            class="form-control" 
                            id="editarTitulo" 
                            th:field="*{titulo}" 
                            maxlength="100"
                            required>
                        <div class="text-danger" th:if="${#fields.hasErrors('titulo')}" th:errors="*{titulo}"></div>
                    </div>

                    <!-- Categoría -->
                    <div class="mb-3">
                        <label for="categoria" class="form-label">Categoría *</label>
                        <select th:field="*{categoria}" id="editarCategoria">
                            <option value="">-- Selecciona una categoría --</option>
                            <option th:each="cat : ${T(com.culturaweb.culturaya.model.enums.Categoria).values()}"
                                    th:value="${cat}"
                                    th:text="${cat}">
                            </option>                                
                        </select>
                        <div class="text-danger" th:if="${#fields.hasErrors('categoria')}" th:errors="*{categoria}"></div>
                    </div>

                    <!-- Lugar -->
                    <div class="mb-3">
                        <label for="lugar" class="form-label">Lugar *</label>
                        <input type="text" 
                                class="form-control" 
                                id="editarLugar" 
                                th:field="*{lugar}" 
                                maxlength="100">
                        <div class="text-danger" th:if="${#fields.hasErrors('lugar')}" th:errors="*{lugar}"></div>
                    </div>

                    <div class="row">
                        <!-- Fecha -->
                        <div class="col-md-6 mb-3">
                            <label for="fecha" class="form-label">Fecha *</label>
                            <input type="text" 
                                    class="form-control" 
                                    id="editarFecha" 
                                    th:field="*{fecha}"
                                    maxlength="100" 
                                    required>
                            <div class="text-danger" th:if="${#fields.hasErrors('fecha')}" th:errors="*{fecha}"></div>
                        </div>
                        <!-- Precio -->
                        <div class="col-md-6 mb-3">
                            <label for="precio" class="form-label">Precio *</label>
                            <input type="text" 
                                    class="form-control" 
                                    id="editarPrecio" 
                                    th:field="*{precio}"
                                    maxlength="100" 
                                    required>
                            <div class="text-danger" th:if="${#fields.hasErrors('precio')}" th:errors="*{precio}"></div>
                        </div>
                    </div>

                    <!-- Descripción -->
                    <div class="mb-3">
                        <label for="descripcion" class="form-label">Descripción *</label>
                        <textarea class="form-control" 
                                    id="editarDescripcion" 
                                    th:field="*{descripcion}" 
                                    rows="3" 
                                    maxlength="500"></textarea>
                        <div class="text-danger" th:if="${#fields.hasErrors('descripcion')}" th:errors="*{descripcion}"></div>
                    </div>

                    <!-- Nombre de la imagen -->
                    <div class="mb-3">
                        <label for="imagenFile" class="form-label">Imagen *</label>
                        <input type="file" 
                            class="form-control" 
                            id="imagenFile" 
                            maxlength="200"
                            accept="image/*" 
                            name="imagenFile"
                            required>
                        <div class="text-danger" th:if="${#fields.hasErrors('imagen')}" th:errors="*{imagen}"></div>
                    </div>

                    <!-- Contenedor para mostrar la imagen actual -->
                    <div class="mt-3" id="imagenActualContainer" style="display: none;">
                        <label class="form-label text-muted">Imagen Actual:</label>
                        <div class="text-center">
                            <img id="imagenActual" 
                                 class="img-fluid rounded border" 
                                 style="max-height: 150px; max-width: 100%;"
                                 alt="Imagen actual de la noticia">
                        </div>
                    </div>

                    <!-- URL del enlace -->
                    <div class="mb-3">
                        <label for="enlace" class="form-label">URL del Enlace *</label>
                        <input type="url" 
                            class="form-control" 
                            id="editarEnlace" 
                            th:field="*{enlace}" 
                            maxlength="200" 
                            placeholder="https://actividad.com/detalle"
                            required>
                        <div class="text-danger" th:if="${#fields.hasErrors('enlace')}" th:errors="*{enlace}"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <!-- Form para cerrar el modal con el método dialog -->
                <form method="dialog">
                    <button type="submit" class="btn btn-secondary">Cancelar</button>
                </form>
                <button type="submit" form="editarActividadForm" class="btn btn-primary">Guardar Actividad</button>
            </div>
        </div>

    </dialog>

    <style>
        /* Estilos para el modal nativo */
        .modal-dialog-native {
            border: none;
            border-radius: 8px;
            padding: 0;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: transparent;

            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
            z-index: 10000;
            
            /* Animación corregida */
            animation: modalAppear 0.3s ease-out;
        }

        .modal-dialog-native::backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            animation: backdropFadeIn 0.3s ease-out;
        }

        .modal-content-native {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid #dee2e6;
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes backdropFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Responsive para móviles */
        @media (max-width: 768px) {
            .modal-dialog-native {
                width: 95%;
                max-width: 95%;
            }
            
            .modal-header,
            .modal-body,
            .modal-footer {
                padding: 1rem;
            }
        }

    </style>

    <script>
        function abrirModalEditarActividad(button) {
            const id = button.getAttribute('data-id');
            const titulo = button.getAttribute('data-titulo');
            const categoria = button.getAttribute('data-categoria');
            const lugar = button.getAttribute('data-lugar');
            const fecha = button.getAttribute('data-fecha');
            const precio = button.getAttribute('data-precio');
            const descripcion = button.getAttribute('data-descripcion');
            const enlace = button.getAttribute('data-enlace');
            const imagen = button.getAttribute('data-imagen');
            
            document.getElementById('editarId').value = id;
            document.getElementById('editarTitulo').value = titulo || '';
            document.getElementById('editarCategoria').value = categoria || '';
            document.getElementById('editarLugar').value = lugar || '';
            document.getElementById('editarFecha').value = fecha || '';
            document.getElementById('editarPrecio').value = precio || '';
            document.getElementById('editarDescripcion').value = descripcion || '';
            document.getElementById('editarEnlace').value = enlace || '';
            
            const imagenActualContainer = document.getElementById('imagenActualContainer');
            const imagenActual = document.getElementById('imagenActual');
            
            if (imagen && imagen.trim() !== '') {
                imagenActual.src = imagen;
                imagenActualContainer.style.display = 'block';
            } else {
                imagenActualContainer.style.display = 'none';
            }

            document.getElementById('editarActividadModal').showModal();
        }

        // Cerrar modales al hacer clic fuera
        document.addEventListener('DOMContentLoaded', function() {
            const modals = document.querySelectorAll('.modal-dialog-native');
            modals.forEach(modal => {
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        modal.close();
                    }
                });
            });
        });

        // Función robusta para auto-ocultar mensajes
        function initAutoHideAlerts() {
            const alerts = document.querySelectorAll('.auto-hide-alert');
            
            alerts.forEach(alert => {
                const hideTime = alert.getAttribute('data-auto-hide') || 3000;
                
                setTimeout(() => {
                    // Si el alert todavía existe y no ha sido cerrado manualmente
                    if (alert && alert.parentNode && !alert.classList.contains('d-none')) {
                        // Usar Bootstrap para cerrar si está disponible
                        if (typeof bootstrap !== 'undefined') {
                            const bsAlert = new bootstrap.Alert(alert);
                            bsAlert.close();
                        } else {
                            // Fallback: animación manual
                            alert.style.transition = 'all 0.5s ease';
                            alert.style.opacity = '0';
                            alert.style.transform = 'translateY(-10px)';
                            
                            setTimeout(() => {
                                if (alert.parentNode) {
                                    alert.style.display = 'none';
                                }
                            }, 500);
                        }
                    }
                }, parseInt(hideTime));
            });
        }
    
        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', initAutoHideAlerts);
        
        // También inicializar después de navegación Thymeleaf (si es necesario)
        document.addEventListener('thymeleaf-rendered', initAutoHideAlerts);

        document.addEventListener('DOMContentLoaded', function () {
            const filtro = document.getElementById('filtroCategoria');
            const tarjetas = document.querySelectorAll('[th\\:each="actividad : ${actividades}"], [data-categoria]');
            
            filtro.addEventListener('change', function () {
                const categoriaSeleccionada = this.value;
                
                // Mostrar/ocultar actividades según la categoría
                document.querySelectorAll('[th\\:each="actividad : ${actividades}"], [data-categoria]').forEach(card => {
                    const categoria = card.getAttribute('data-categoria');
                    if (categoriaSeleccionada === 'TODAS' || categoria === categoriaSeleccionada) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        });

    </script>

</div>
